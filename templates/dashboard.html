{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid px-4">
  <!-- Header -->
  <div class="mb-4">
    <h2 class="mb-1">Dashboard</h2>
    <p class="text-muted mb-0">Comprehensive overview of disaster relief operations</p>
  </div>

  <!-- Key Metrics -->
  <div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 small">Total Hubs</p>
              <h3 class="mb-0">{{ locations_full|length }}</h3>
              <small class="text-success"><i class="bi bi-geo-alt me-1"></i>{{ locations_full|selectattr('status', 'equalto', 'Active')|list|length }} Active</small>
            </div>
            <div class="icon-box bg-primary bg-opacity-10 text-primary">
              <i class="bi bi-building"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 small">Total Stock</p>
              <h3 class="mb-0">{{ "{:,}".format(total_in_stock) }}</h3>
              <small class="text-muted"><i class="bi bi-box me-1"></i>{{ total_items }} Items</small>
            </div>
            <div class="icon-box bg-success bg-opacity-10 text-success">
              <i class="bi bi-boxes"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 small">Active Needs Lists</p>
              <h3 class="mb-0">{{ needs_lists_stats.pending + needs_lists_stats.in_progress }}</h3>
              <small class="text-warning"><i class="bi bi-clock me-1"></i>{{ needs_lists_stats.pending }} Pending</small>
            </div>
            <div class="icon-box bg-warning bg-opacity-10 text-warning">
              <i class="bi bi-clipboard-check"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 small">Low Stock Alerts</p>
              <h3 class="mb-0">{{ low_stock_full|length }}</h3>
              <small class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Needs Attention</small>
            </div>
            <div class="icon-box bg-danger bg-opacity-10 text-danger">
              <i class="bi bi-exclamation-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <!-- Operational Insights -->
    <div class="col-lg-8">
      <div class="row g-3 mb-3">
        <!-- Hubs Overview -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-3">
              <h6 class="card-title mb-3"><i class="bi bi-building me-2"></i>Hubs Overview</h6>
              <div class="d-flex flex-column gap-2">
                {% for hub_type, count in hubs_by_type.items() %}
                  <div class="d-flex justify-content-between">
                    <span class="text-muted small">{{ hub_type }}</span>
                    <strong>{{ count }}</strong>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Top Categories -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-3">
              <h6 class="card-title mb-3"><i class="bi bi-grid me-2"></i>Top Categories</h6>
              <div class="d-flex flex-column gap-2">
                {% for category in category_labels[:3] %}
                  <div class="d-flex justify-content-between">
                    <span class="text-muted small">{{ category }}</span>
                    <span class="badge bg-success">{{ category_data[loop.index0] }}</span>
                  </div>
                {% else %}
                  <p class="text-muted small mb-0">No categories</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Needs Lists Status -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-3">
              <h6 class="card-title mb-3"><i class="bi bi-clipboard-check me-2"></i>Needs Lists</h6>
              <div class="d-flex flex-column gap-2">
                {% for status, count in needs_lists_chart_data.items() %}
                  <div class="d-flex justify-content-between">
                    <span class="text-muted small">{{ status }}</span>
                    <strong>{{ count }}</strong>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Transaction Activity -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h6 class="mb-0"><i class="bi bi-activity me-2"></i>Transaction Activity (Last 30 Days)</h6>
        </div>
        <div class="card-body">
          <div class="row text-center g-3">
            <div class="col-6">
              <div class="border-end">
                <p class="text-muted small mb-1">Intakes</p>
                <h4 class="text-success mb-0">{{ "{:,}".format(recent_intakes) }}</h4>
                <small class="text-muted">of {{ "{:,}".format(total_intakes) }} total</small>
              </div>
            </div>
            <div class="col-6">
              <p class="text-muted small mb-1">Distributions</p>
              <h4 class="text-danger mb-0">{{ "{:,}".format(recent_distributions) }}</h4>
              <small class="text-muted">of {{ "{:,}".format(total_distributions) }} total</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Feed & Quick Actions -->
    <div class="col-lg-4">
      <!-- Quick Actions -->
      {% if current_user.role in ['ADMIN', 'LOGISTICS_MANAGER', 'LOGISTICS_OFFICER', 'WAREHOUSE_STAFF'] %}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
        </div>
        <div class="card-body p-2">
          <div class="d-grid gap-2">
            {% if current_user.role in ['ADMIN', 'LOGISTICS_OFFICER', 'LOGISTICS_MANAGER', 'WAREHOUSE_STAFF'] %}
              <a href="{{ url_for('intake') }}" class="btn btn-outline-success btn-sm text-start">
                <i class="bi bi-box-arrow-in-down me-2"></i>Record Intake
              </a>
              <a href="{{ url_for('distribute') }}" class="btn btn-outline-danger btn-sm text-start">
                <i class="bi bi-box-arrow-up me-2"></i>Record Distribution
              </a>
            {% endif %}
            {% if current_user.role in ['ADMIN', 'LOGISTICS_MANAGER'] %}
              <a href="{{ url_for('depots') }}" class="btn btn-outline-primary btn-sm text-start">
                <i class="bi bi-building-add me-2"></i>Manage Hubs
              </a>
            {% endif %}
            <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary btn-sm text-start">
              <i class="bi bi-clock-history me-2"></i>View History
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Recent Activity -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h6>
          <a href="{{ url_for('transactions') }}" class="btn btn-sm btn-link p-0">View All</a>
        </div>
        <div class="card-body p-0">
          <div class="activity-feed">
            {% for t in recent_preview %}
              <div class="activity-item">
                <div class="activity-icon bg-{{ 'success' if t.ttype == 'IN' else 'danger' }} bg-opacity-10 text-{{ 'success' if t.ttype == 'IN' else 'danger' }}">
                  <i class="bi bi-{{ 'arrow-down-circle' if t.ttype == 'IN' else 'arrow-up-circle' }}"></i>
                </div>
                <div class="activity-content">
                  <p class="mb-0 small"><strong>{{ t.ttype }}</strong>: {{ t.item.name[:30] }}{% if t.item.name|length > 30 %}...{% endif %}</p>
                  <small class="text-muted">{{ t.qty }} {{ t.item.unit }} â€¢ {{ t.created_at.strftime("%b %d, %H:%M") }}</small>
                </div>
              </div>
            {% else %}
              <div class="text-center py-4 text-muted">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">No recent activity</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts & Lists -->
  <div class="row g-3">
    <!-- Low Stock Alerts -->
    {% if low_stock_preview %}
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-warning bg-opacity-10">
          <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>Low Stock Alerts</h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Depot</th>
                  <th class="text-end">Stock</th>
                </tr>
              </thead>
              <tbody>
                {% for item, depot, stock in low_stock_preview %}
                  <tr>
                    <td><strong>{{ item.name }}</strong></td>
                    <td><small>{{ depot.name }}</small></td>
                    <td class="text-end text-danger"><strong>{{ stock }}</strong> <small class="text-muted">{{ item.unit }}</small></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if low_stock_full|length > 5 %}
            <div class="card-footer bg-white text-center py-2">
              <a href="{{ url_for('items') }}" class="btn btn-sm btn-link">View All ({{ low_stock_full|length }})</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Expiring Items -->
    {% if expiring_items_preview %}
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-danger bg-opacity-10">
          <h6 class="mb-0 text-danger"><i class="bi bi-calendar-x me-2"></i>Expiring Soon</h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Expiry Date</th>
                  <th class="text-end">Days Left</th>
                </tr>
              </thead>
              <tbody>
                {% for exp_item in expiring_items_preview %}
                  <tr class="{% if exp_item.urgency == 'critical' %}table-danger{% elif exp_item.urgency == 'warning' %}table-warning{% endif %}">
                    <td><strong>{{ exp_item.item.name }}</strong></td>
                    <td><small>{{ exp_item.transaction.expiry_date.strftime("%Y-%m-%d") }}</small></td>
                    <td class="text-end">
                      <span class="badge bg-{% if exp_item.urgency == 'critical' %}danger{% else %}warning{% endif %}">
                        {{ exp_item.days_remaining }} days
                      </span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if expiring_items_full|length > 5 %}
            <div class="card-footer bg-white text-center py-2">
              <a href="{{ url_for('transactions') }}" class="btn btn-sm btn-link">View All ({{ expiring_items_full|length }})</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Stock by Category -->
    <div class="col-lg-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-grid me-2"></i>Inventory by Category</h6>
          <a href="{{ url_for('items') }}" class="btn btn-sm btn-link p-0">Manage Inventory</a>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="text-center">Items</th>
                  <th class="text-end">Total Units</th>
                </tr>
              </thead>
              <tbody>
                {% for category, stats in stock_by_category_preview %}
                  <tr>
                    <td><strong>{{ category }}</strong></td>
                    <td class="text-center">{{ stats['items']|length }}</td>
                    <td class="text-end">{{ "{:,}".format(stats['total_units']) }}</td>
                  </tr>
                {% else %}
                  <tr><td colspan="3" class="text-center py-3 text-muted">No inventory data available</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if stock_by_category_full|length > 5 %}
            <div class="card-footer bg-white text-center py-2">
              <button class="btn btn-sm btn-link" data-bs-toggle="collapse" data-bs-target="#moreCategories">
                Show More
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .icon-box {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
  }
  
  .activity-feed {
    max-height: 400px;
    overflow-y: auto;
  }
  
  .activity-item {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
  }
  
  .activity-item:hover {
    background-color: #f8f9fa;
  }
  
  .activity-item:last-child {
    border-bottom: none;
  }
  
  .activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1.25rem;
  }
  
  .activity-content {
    flex-grow: 1;
  }
</style>

{% endblock %}
